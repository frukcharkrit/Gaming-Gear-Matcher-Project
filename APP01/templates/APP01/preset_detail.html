{% extends 'APP01/base.html' %}
{% load static %}

{% block title %}Preset Detail - {{ preset.name }}{% endblock %}

{% block content %}
    {# ✅ เรียกใช้ไฟล์ CSS ภายนอก (ต้องแน่ใจว่าคุณสร้างไฟล์ static/css/preset_detail.css แล้ว) #}
    <link rel="stylesheet" href="{% static 'css/preset_detail.css' %}">

    <div class="container mt-5 mb-5">
        
        {# --- ส่วนแสดงข้อความแจ้งเตือน (Messages) --- #}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {# --- Header และปุ่ม Actions --- #}
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="preset-title">{{ preset.name }}</h1> 
            
            <div>
                {# ปุ่ม Share Preset #}
                <button 
                    type="button" 
                    class="btn btn-sm btn-share" 
                    onclick="copyShareLink()">
                    <i class="fas fa-share-alt me-1"></i> Share Preset
                </button>
                
                {# ปุ่ม Edit Name (เปิด Modal) #}
                <button 
                    type="button" 
                    class="btn btn-sm btn-outline-primary" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editNameModal">
                    <i class="fas fa-edit me-1"></i> Edit Name
                </button>
            </div>
        </div>
        
        <p class="text-muted">Saved: {{ preset.created_at|date:"d M Y" }}</p>
        
        <hr>

        {# --- รายการอุปกรณ์ใน Preset --- #}
        <h2 class="list-header"><i class="fas fa-microchip me-2"></i>Preset Gears ({{ preset.presetgear_set.count }})</h2>
        
        {% if preset.presetgear_set.all %}
            <div class="row">
                {# วนลูปแสดงการ์ดอุปกรณ์ #}
                {% for preset_gear in preset.presetgear_set.all|dictsort:"order" %}
                    <div class="col-md-6">
                        <div class="gear-card">
                            <div class="gear-icon">
                                {# Logic เลือกไอคอนตามประเภทอุปกรณ์ #}
                                {% if preset_gear.gear.gear_type == 'Mouse' %}<i class="fas fa-mouse"></i>
                                {% elif preset_gear.gear.gear_type == 'Keyboard' %}<i class="fas fa-keyboard"></i>
                                {% elif preset_gear.gear.gear_type == 'Headset' %}<i class="fas fa-headset"></i>
                                {% else %}<i class="fas fa-cog"></i>
                                {% endif %}
                            </div>
                            <div class="gear-info">
                                <h5>{{ preset_gear.gear.name }}</h5>
                                <p>Type: {{ preset_gear.gear.gear_type }} | Brand: {{ preset_gear.gear.brand }}</p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            {# กรณีไม่มีอุปกรณ์ #}
            <div class="alert alert-warning" role="alert">
                This preset has no gears saved.
            </div>
        {% endif %}

    </div>

    {# --- MODAL: สำหรับแก้ไขชื่อ Preset --- #}
    <div class="modal fade" id="editNameModal" tabindex="-1" aria-labelledby="editNameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editNameModalLabel">Edit Preset Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <form method="POST" action="{% url 'edit_preset_name' preset_id=preset.preset_id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="id_name" class="form-label">New Preset Name</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="id_name" 
                                name="name" 
                                value="{{ preset.name }}" 
                                required 
                                maxlength="255">
                            <div class="form-text">Max 255 characters.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{# --- JavaScript Section --- #}
{% block extra_js %}
<script>
    function copyShareLink() {
        // 1. ดึง URL ปัจจุบัน
        const shareLink = window.location.href;
        
        // 2. ใช้ Navigator API ในการคัดลอก (วิธีมาตรฐาน)
        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareLink).then(() => {
                alert("Link copied to clipboard: " + shareLink);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert("Failed to copy link. Please manually copy this: " + shareLink);
            });
        } else {
            // Fallback สำหรับเบราว์เซอร์เก่า
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = shareLink;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert("Link copied to clipboard (Legacy method): " + shareLink);
        }
    }
</script>
{% endblock %}