{% extends 'APP01/base.html' %}

{% block title %}Find Your Perfect Gear{% endblock %}

{% block content %}
<div class="text-center mt-5">
    <h1 class="display-4 fw-bold">FIND YOUR PERFECT GEAR</h1>

    <form method="post" enctype="multipart/form-data" action="{% url 'upload_image' %}">
        {% csrf_token %}
        
        <div class="d-flex justify-content-center flex-wrap my-4">
            <div class="form-check form-check-inline mx-3 my-2">
                <input class="form-check-input" type="checkbox" id="mouseCheckbox" name="gear_types" value="Mouse">
                <label class="form-check-label fw-bold fs-5" for="mouseCheckbox">MOUSE</label>
            </div>
            <div class="form-check form-check-inline mx-3 my-2">
                <input class="form-check-input" type="checkbox" id="keyboardCheckbox" name="gear_types" value="Keyboard">
                <label class="form-check-label fw-bold fs-5" for="keyboardCheckbox">KEYBOARD</label>
            </div>
            <div class="form-check form-check-inline mx-3 my-2">
                <input class="form-check-input" type="checkbox" id="headsetCheckbox" name="gear_types" value="Headset">
                <label class="form-check-label fw-bold fs-5" for="headsetCheckbox">HEADSET</label>
            </div>
            <div class="form-check form-check-inline mx-3 my-2">
                <input class="form-check-input" type="checkbox" id="monitorCheckbox" name="gear_types" value="Monitor">
                <label class="form-check-label fw-bold fs-5" for="monitorCheckbox">MONITOR</label>
            </div>
            <div class="form-check form-check-inline mx-3 my-2">
                <input class="form-check-input" type="checkbox" id="chairCheckbox" name="gear_types" value="Chair">
                <label class="form-check-label fw-bold fs-5" for="chairCheckbox">CHAIR</label>
            </div>
        </div>

        <div class="card p-5 border-2 border-primary border-dashed position-relative d-flex flex-column justify-content-center align-items-center"
             style="height: 300px; max-width: 600px; margin: 0 auto; cursor: pointer;"
             id="uploadArea">
            
            <input type="file" name="image" id="imageUpload" accept="image/*" class="position-absolute w-100 h-100 opacity-0 cursor-pointer" style="left: 0; top: 0;" required>
            
            <div id="uploadContent">
                <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="#007bff" class="bi bi-cloud-upload-fill mb-3" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0a5.53 5.53 0 0 0-3.594 1.391c-.829.93-1.765 2.2-2.316 3.553C.726 6.535 0 7.324 0 8.311 0 9.84 1.154 11 2.5 11h11c1.346 0 2.5-1.161 2.5-2.689 0-1.077-.492-2.12-1.1-3.15-.704-1.233-1.688-2.368-2.607-3.233C10.745 2.116 9.52 1 8 1Z"/>
                    <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0L10.207 6.207a.5.5 0 0 1-.708.708L8.5 5.707V9.5a.5.5 0 0 1-1 0V5.707L6.207 6.915a.5.5 0 1 1-.708-.708z"/>
                </svg>
                <p class="text-primary fw-bold">UPLOAD YOUR PHOTO HERE</p>
            </div>
            
            <img id="imagePreview" src="#" alt="Image Preview" class="img-fluid rounded position-absolute w-100 h-100 object-fit-cover" style="display: none; left: 0; top: 0;">
            <div id="loadingSpinner" class="spinner-border text-primary position-absolute" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <p class="text-muted mt-3 mb-4">โปรดอัปโหลดรูปภาพที่แสดงสรีระของคุณอย่างชัดเจน</p>
        
        {# ปุ่ม Submit ที่อยู่ตรงกลางและข้อความเปลี่ยน #}
        <div class="d-grid col-6 mx-auto">
            <button type="submit" class="btn btn-primary btn-lg mt-3" id="submitButton" style="display: none;">START MATCHING</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const uploadContent = document.getElementById('uploadContent');
        const submitButton = document.getElementById('submitButton');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Function to reset the upload area
        function resetUploadArea() {
            imagePreview.src = '#';
            imagePreview.style.display = 'none';
            uploadContent.style.display = 'block';
            submitButton.style.display = 'none';
            uploadArea.classList.add('border-dashed');
            loadingSpinner.style.display = 'none';
            uploadArea.style.pointerEvents = 'auto'; // Re-enable click
            uploadArea.style.opacity = '1'; // Reset opacity
            imageUpload.value = ''; // Clear the selected file
            // Optionally uncheck checkboxes here if needed
            // document.querySelectorAll('input[name="gear_types"]').forEach(checkbox => checkbox.checked = false);
        }

        uploadArea.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', function(event) {
            if (event.target.files && event.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadContent.style.display = 'none';
                    submitButton.style.display = 'block'; // Show submit button after image is selected
                    uploadArea.classList.remove('border-dashed'); // Remove dashed border
                };
                reader.readAsDataURL(event.target.files[0]);
            } else {
                resetUploadArea(); // Reset if no file selected
            }
        });

        // Show loading spinner on form submission
        document.querySelector('form').addEventListener('submit', function() {
            submitButton.style.display = 'none';
            loadingSpinner.style.display = 'block'; // Show spinner
            uploadArea.style.pointerEvents = 'none'; // Disable click on upload area during submission
            uploadArea.style.opacity = '0.7'; // Dim upload area
        });
        
        // Ensure initial state is correct (e.g., if page is refreshed)
        resetUploadArea();
    });
</script>
{% endblock %}