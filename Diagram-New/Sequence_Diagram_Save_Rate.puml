@startuml Sequence_Diagram_Full_Process
!theme plain
title Sequence Diagram: Full Process (Select - Save - Rate)

actor User
participant "Browser" as Viewer
participant "Home/Category View" as Home
participant "Wizard View" as Wizard
participant "Session" as Session
participant "Matching System" as Matching
participant "Save Preset View" as SaveView
participant "Database" as DB
participant "Preset Detail View" as DetailView

== Phase 1: Gear Selection ==
User -> Viewer: Open Home Page
Viewer -> Home: GET /
Home --> Viewer: Show Categories (Mouse, Keyboard, etc.)

opt Select Feature
    User -> Viewer: Select Category (e.g., Mouse)
    Viewer -> Wizard: GET /category/mouse/
    Wizard -> DB: Query GamingGear (Type=Mouse)
    DB --> Wizard: Return Gear List
    Wizard --> Viewer: Show Gear Cards
end

User -> Viewer: Click "Select" on specific gear
Viewer -> Wizard: POST /wizard/add/<gear_id>
Wizard -> Session: Get 'wizard_preset' list

alt Gear of same type exists?
    Wizard -> Session: Remove old gear ID
    Session --> Wizard: Removed
end

Wizard -> Session: Add new gear ID
Session --> Wizard: Updated List
Wizard --> Viewer: Redirect to Matching Result

== Phase 2: Matching & Review ==
Viewer -> Matching: GET /matching_result/
Matching -> Session: Get 'wizard_preset'
Matching -> DB: Query ProPlayer Association Rules
DB --> Matching: Return Recommendations
Matching --> Viewer: Show Selected Gears + Recommendations

User -> Viewer: Click "Next: Review & Save"

alt User is NOT Logged in
    Viewer -> SaveView: GET /preset/save/
    SaveView -> Viewer: Redirect to /login/
    User -> Viewer: Enter Credentials
    Viewer -> SaveView: POST /login/
    SaveView -> Viewer: Redirect back to /preset/save/
end

== Phase 3: Save Preset ==
Viewer -> SaveView: GET /preset/save/
SaveView -> Session: Retrieve Gear IDs
SaveView -> DB: Validate Gear Objects
SaveView --> Viewer: Show Form (Enter Preset Name)

User -> Viewer: Input Name "My Pro Setup" & Submit
Viewer -> SaveView: POST /preset/save/
SaveView -> DB: Create Preset (User, Name)
activate DB
DB --> SaveView: Preset Created (ID: 101)
deactivate DB

loop For each Gear ID
    SaveView -> DB: Create PresetGear (PresetID, GearID)
end

SaveView -> Session: Clear 'wizard_preset'
SaveView --> Viewer: Redirect to /preset/101/

== Phase 4: Rating & Feedback ==
Viewer -> DetailView: GET /preset/101/
DetailView -> DB: Fetch Preset & Gears
DetailView -> DB: Check existing Rating (User, Preset)
DB --> DetailView: Return None (Not rated yet)
DetailView --> Viewer: Render Detail Page + Rating Form

User -> Viewer: Click 5 Stars & Comment "Best setup!"
Viewer -> DetailView: POST /preset/101/rate/
DetailView -> DB: Save PresetRating (Score=5, Comment)
activate DB
DB --> DetailView: Saved
deactivate DB

DetailView -> Viewer: Redirect to /preset/101/
Viewer -> Viewer: Display "Thank You" & Show Saved Stars

@enduml
